# functional/

In this folder, functional tests are placed.

## Sections

- [functional/](#functional)
  - [Sections](#sections)
  - [Functional Tests](#functional-tests)
    - [Anatomy of a AzOps functional test](#anatomy-of-a-azops-functional-test)
    - [How are tests invoked](#how-are-tests-invoked)
    - [How to add a new functional test resource-type and resource-provider](#how-to-add-a-new-functional-test-resource-type-and-resource-provider)

---

## Functional Tests

The functional tests are used to ensure that AzOps autogenerated templates behaviour works as expected for individual resources providers and resource types when it comes to `Pull`, `Push` and `Delete` operations.

---

### Anatomy of a AzOps functional test

Consists of a folder structure and files broken down below:

Folder structure: `<resource.provider>/<resourcetype>/<deploy>`.

Files: `scenario.ps1`, `deploy.ps1` and deployment templates `example.json` (*optional parameter file `example.parameters.json`*).

Illustration below:

```bash
tests
└── functional
    ├── resource.provider1
    │   ├── resourcetypeA
    │   │   ├── scenario.ps1
    │   │   └── deploy
    │   │       ├── example.json
    │   │       ├── example.parameters.json
    │   │       └── deploy.ps1
    │   ├── resourcetypeB
    │   │   ├── scenario.ps1
    │   │   └── deploy
    │   │       ├── example.bicep
    │   │       ├── example.parameters.json
    │   │       └── deploy.ps1
    ├── resource.provider2
    │   ├── resourcetypeC
    │   │   ├── scenario.ps1
    │   │   └── deploy
    │   │       ├── example.json
    │   │       ├── example.parameters.json
    │   │       └── deploy.ps1
    ├── Functional.Tests.ps1
    ├── README.md

```
---

### How are tests invoked

`Functional.Tests.ps1` is responsible for orchestrating functional tests *(The overall test orchestration caller is `Pester.ps1`)*.
   1. `BeforeAll` section prepares the conditions for success and connects to Azure.
   2. Looks for all `deploy.ps1` files in the `functional/*` hierarchy.
   3. Runs all `deploy.ps1` files.
   4. Pulls back resources from Azure by running `Invoke-AzOpsPull.ps1`
   5. Initiates test section by looking for the existence of a root folder produced by previous step.
   6. Looks for all `scenario.ps1` files in the `functional/*` hierarchy.
   7. Runs all `scenario.ps1` files.
   8. Initiates `AfterAll` section.
   9. Done.

---

### How to add a new functional test resource-type and resource-provider

Steps:

1. Check the current `functional/*` hierarchy to ensure that the resource-type and resource-provider does not already exist.
2. Pick one of the existing resource-type and and resource-provider tests to use as the base for your addition.
3. Copy the and resource-provider structure you choose in step before.
4. Paste the copied information into the `functional/*` hierarchy root.
5. Rename `<resource.provider>/<resourcetype>` folders of the newly created structure according to the new resource-type and resource-provider test you are adding.
6. Update the deployable `.json` or `.bicep` template files in the `deploy/*` folder to ensure it reflects your intended test.
7. Update the `deploy.ps1` file to ensure it reflects your intended setup and associated template files.
8. Update the `scenario.ps1` file to ensure it reflects your intended test.
   1. First row `Describe "Scenario - <replaceMe>" {`
   2. Region path parameter `$script:functionalTestDeploy.value.parameters.<replaceMe>.value` to successfully identify the file created by `Invoke-AzOpsPull.ps1` as a result of this resource-type test.
   3. For all resources the test runs `Pull` and `Push` consider if `Delete` is required.
   4. Determine modifications required at `#region Pull Test` section to examine specific properties `$script:fileContents.resources[0].properties.<replaceMe>` to uniquely identify some resource-type property.
9. Done

---