---
name: "AzOps - Tests"

on:
  workflow_dispatch:
  
  pull_request:
    paths:
      - "src/**"

env:
  #
  # Credentials
  #

  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

permissions:
      id-token: write
      contents: write
      pull-requests: write
      
jobs:
  validate:
    #
    # Validate
    #

    name: "Validate"
    runs-on: ubuntu-20.04
    environment: test
    
    steps:

      # Checkout
      - name: "Checkout"
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      # Dependencies      
      - name: "Dependencies"
        shell: pwsh
        run: |
          ./scripts/Dependencies.ps1

      # Authenticate Azure context   
      - name: OIDC Login to Azure Public Cloud with AzPowershell (enableAzPSSession true)
        uses: azure/login@v1
        with:
          client-id: ${{ env.ARM_CLIENT_ID}}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }} 
          enable-AzPSSession: true
      
      # Run Tests   
      - name: "Run Tests"
        shell: pwsh
        run: |
          ./scripts/Tests.ps1