---
name: 'Tests'

trigger: none

pool:
  vmImage: ubuntu-20.04

variables:
  - name: ARM_TENANT_ID
    value: $(ARM_TENANT_ID)
  - name: ARM_SUBSCRIPTION_ID
    value: $(ARM_SUBSCRIPTION_ID)
  - name: ARM_CLIENT_ID
    value: $(ARM_CLIENT_ID)
  - name: ARM_CLIENT_SECRET
    value: $(ARM_CLIENT_SECRET)

jobs:
  - job: tests
    displayName: 'Tests'
    steps:
      - task: PowerShell@2
        displayName: 'Install Dependencies'
        inputs:
          targetType: filePath
          filePath: ./scripts/Dependencies.ps1
      - task: PowerShell@2
        displayName: 'Deploy Infrastructure'
        inputs:
          targetType: inline
          script: |
            . ./scripts/Deployments.ps1
            New-Deployment
      # - task: PowerShell@2
      #   displayName: 'Run Tests'
      #   inputs:
      #     targetType: filePath
      #     filePath: ./scripts/Tests.ps1
      # - task: PublishTestResults@2
      #   displayName: 'Upload Results'
      #   inputs:
      #     testResultsFiles: '**/*.Tests.xml'
      #     testResultsFormat: NUnit
        condition: always()
      - task: PowerShell@2
        displayName: 'Destroy Infrastructure'
        inputs:
          targetType: inline
          script: |
            . ./scripts/Deployments.ps1
            Remove-Deployment